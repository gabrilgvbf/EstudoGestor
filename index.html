<script>
// === CONFIGURAÇÕES ===
const CLIENT_ID = '374929675068-4datkhc3lt6jseb4tuqs8t9hliig2qdl.apps.googleusercontent.com';

// === DADOS ===
const materias = [
  {nome:'LÍNGUA PORTUGUESA',topicos:['Compreensão de textos','Ortografia oficial','Classe e emprego de palavras','Emprego do acento indicativo de crase','Sintaxe da oração e do período','Emprego dos sinais de pontuação','Concordância verbal e nominal','Regência verbal e nominal','Colocação dos pronomes oblíquos átonos'],peso:2},
  {nome:'LÍNGUA INGLESA',topicos:['Vocabulário fundamental','Aspectos gramaticais básicos'],peso:1},
  {nome:'MATEMÁTICA',topicos:['Números inteiros, racionais e reais','Sistema legal de medidas','Razões e proporções','Lógica proposicional','Noções de conjuntos','Relações e funções','Matrizes','Determinantes','Sistemas lineares','Sequências','Progressões aritméticas e geométricas'],peso:2},
  {nome:'ATUALIDADES DO MERCADO FINANCEIRO',topicos:['Bancos na Era Digital','Internet banking e Mobile banking','Open banking','Fintechs, startups e big techs','Shadow banking','Blockchain e criptomoedas','PIX e arranjos de pagamento','Transformação digital no sistema financeiro'],peso:1},
  {nome:'PROBABILIDADE E ESTATÍSTICA',topicos:['Representação tabular e gráfica','Medidas de tendência central e dispersão','Variáveis aleatórias e distribuições','Teorema de Bayes e probabilidade condicional','Distribuição binomial e normal','Noções de amostragem e inferência estatística'],peso:1},
  {nome:'CONHECIMENTOS BANCÁRIOS',topicos:['Sistema Financeiro Nacional','Mercado financeiro','Política monetária e SELIC','Orçamento público e dívida pública','Produtos bancários','Mercado de câmbio','Taxas de juros e curva de juros','Lavagem de dinheiro e LGPD','Segurança cibernética e responsabilidade socioambiental'],peso:2},
  {nome:'TECNOLOGIA DA INFORMAÇÃO',topicos:['Aprendizagem de máquina','Banco de dados SQL e NoSQL','Big Data','Desenvolvimento Mobile','Estrutura de dados e algoritmos','Ferramentas e linguagens para dados'],peso:3}
];

let historico = JSON.parse(localStorage.getItem('bb-historico-v10')) || [];
let cicloAtual = [], indiceAtual = 0, timerCiclo = null, tempoRestante = 0, cicloPausado = false;
let pomodoroTime = 25 * 60, timerInterval = null;
let googleLoaded = false, googleSignedIn = false;

// === SALVAR E ATUALIZAR ===
function salvar() {
  localStorage.setItem('bb-historico-v10', JSON.stringify(historico));
  atualizarTudo();
}

function atualizarTudo() {
  atualizarTabela();
  atualizarEstatisticas();
  renderizarMaterias();
  atualizarStatusDrive();
}

// === GOOGLE SIGN-IN (GSI) ===
function initializeGoogleSignIn() {
  if (typeof google !== 'undefined' && google.accounts && !googleLoaded) {
    googleLoaded = true;
    console.log('Google GSI carregado!');

    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: handleCredentialResponse
    });

    google.accounts.id.renderButton(
      document.getElementById('g_id_signin'),
      { theme: "filled_blue", size: "large", text: "signin_with" }
    );

    const token = localStorage.getItem('google_token');
    if (token) {
      googleSignedIn = true;
      atualizarStatusDrive();
    }
  }
}

function handleCredentialResponse(response) {
  googleSignedIn = true;
  localStorage.setItem('google_token', response.credential);
  atualizarStatusDrive();
  alert('Login realizado com sucesso!\n\nVocê pode fazer backup no Drive agora.');
}

function logoutGoogle() {
  localStorage.removeItem('google_token');
  googleSignedIn = false;
  atualizarStatusDrive();
}

function atualizarStatusDrive() {
  const el = document.getElementById('driveStatus');
  if (!googleLoaded) {
    el.innerHTML = 'Carregando Google Drive...';
    return;
  }
  if (googleSignedIn) {
    el.innerHTML = `
      Conectado ao Google Drive!
      <button class="btn-warning" style="margin-left:10px; padding:6px 12px; font-size:0.9rem;" onclick="exportarParaDrive()">Backup Agora</button>
      <button class="btn-secondary" style="margin-left:5px; padding:6px 12px; font-size:0.9rem;" onclick="listarBackupsDrive()">Restaurar</button>
      <button class="btn-danger" style="margin-left:5px; padding:6px 12px; font-size:0.9rem;" onclick="logoutGoogle()">Sair</button>
    `;
  } else {
    el.innerHTML = 'Clique no botão para conectar ao Google Drive';
  }
}

// === BACKUP NO DRIVE (CORRIGIDO) ===
async function exportarParaDrive() {
  if (!googleSignedIn) return alert('Faça login no Google primeiro!');
  const token = localStorage.getItem('google_token');
  if (!token) return alert('Token não encontrado. Faça login novamente.');

  const dados = { version: 'v10', timestamp: new Date().toISOString(), historico };
  const content = JSON.stringify(dados, null, 2);
  const fileName = `bb-estudo-backup-${new Date().toISOString().slice(0,10)}.json`;

  const boundary = '-------314159265358979323846';
  const delimiter = "\r\n--" + boundary + "\r\n";
  const close_delim = "\r\n--" + boundary + "--";

  const metadata = { name: fileName, mimeType: 'application/json', parents: ['appDataFolder'] };
  const body = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter +
               'Content-Type: application/json\r\n\r\n' + content + close_delim;

  try {
    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'multipart/related; boundary=' + boundary
      },
      body: body
    });

    if (response.ok) {
      alert('Backup salvo com sucesso no Google Drive!');
    } else {
      const err = await response.text();
      console.error('Erro:', err);
      alert('Erro ao salvar. Tente fazer login novamente.');
    }
  } catch (error) {
    console.error('Erro de rede:', error);
    alert('Sem conexão com a internet.');
  }
}

async function listarBackupsDrive() {
  if (!googleSignedIn) return alert('Faça login primeiro!');
  const token = localStorage.getItem('google_token');

  try {
    const response = await fetch('https://www.googleapis.com/drive/v3/files?q=mimeType%3D%27application%2Fjson%27%20and%20%27appDataFolder%27%20in%20parents&spaces=appDataFolder', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await response.json();

    if (!data.files || data.files.length === 0) return alert('Nenhum backup encontrado no Drive.');

    let msg = 'Últimos 5 backups:\n\n';
    data.files.slice(-5).reverse().forEach(f => {
      const date = f.name.match(/\d{4}-\d{2}-\d{2}/)?.[0] || 'Data desconhecida';
      msg += `• ${date} (ID: ${f.id})\n`;
    });
    msg += '\nCole o ID do backup para restaurar:';

    const id = prompt(msg);
    if (!id) return;

    const fileResp = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (fileResp.ok) {
      const dados = await fileResp.json();
      if (confirm(`Restaurar backup de ${new Date(dados.timestamp).toLocaleDateString()}?\n\nIsso substituirá seu progresso atual.`)) {
        historico = dados.historico;
        salvar();
        alert('Backup restaurado com sucesso!');
      }
    } else {
      alert('ID inválido ou arquivo corrompido.');
    }
  } catch (error) {
    alert('Erro ao conectar com o Drive.');
  }
}

// === RESTANTE DAS FUNÇÕES (TABELA, ESTATÍSTICAS, MATÉRIAS, CICLO, POMODORO, NOTAS) ===
function atualizarTabela() {
  const tbody = document.getElementById('tabelaHistorico');
  tbody.innerHTML = '';
  historico.forEach((h, i) => {
    const duracao = h.fim ? Math.round((new Date(h.fim) - new Date(h.inicio)) / 60000) + ' min' : '-';
    const tr = document.createElement('tr');
    tr.className = h.status === 'Concluído' ? 'concluido' : h.status === 'Em andamento' ? 'andamento' : '';
    tr.innerHTML = `
      <td>${h.materia}</td>
      <td>${h.topico}</td>
      <td>${formatarHora(h.inicio)}</td>
      <td>${h.fim ? formatarHora(h.fim) : '-'}</td>
      <td>${duracao}</td>
      <td>${h.status}</td>
      <td><button class="btn-delete" onclick="excluirRegistro(${i})">Excluir</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function excluirRegistro(i) {
  if (confirm('Excluir este registro?')) {
    historico.splice(i, 1);
    salvar();
  }
}

function atualizarEstatisticas() {
  const hoje = new Date().toISOString().slice(0,10);
  let tempoHoje = 0, tempoSemana = 0, concluidos = 0, totalPesoConcluido = 0, totalPeso = 0;

  const inicioSemana = new Date();
  inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay() + 1);
  inicioSemana.setHours(0,0,0,0);

  materias.forEach(m => totalPeso += m.peso * m.topicos.length);

  historico.forEach(h => {
    if (h.fim) {
      const inicio = new Date(h.inicio);
      const fim = new Date(h.fim);
      const mins = Math.round((fim - inicio) / 60000);
      if (h.inicio.slice(0,10) === hoje) tempoHoje += mins;
      if (inicio >= inicioSemana) tempoSemana += mins;
      if (h.status === 'Concluído') {
        concluidos++;
        const materia = materias.find(m => m.nome === h.materia);
        if (materia) totalPesoConcluido += materia.peso;
      }
    }
  });

  const progresso = totalPeso > 0 ? Math.round((totalPesoConcluido / totalPeso) * 100) : 0;

  document.getElementById('tempoHoje').textContent = tempoHoje;
  document.getElementById('tempoSemana').textContent = tempoSemana;
  document.getElementById('topicosConcluidos').textContent = concluidos;
  document.getElementById('progressoGeral').textContent = progresso;
}

function renderizarMaterias() {
  const container = document.getElementById('materias');
  container.innerHTML = '';
  materias.forEach(m => {
    const div = document.createElement('div');
    div.className = 'materia';
    const concluidos = m.topicos.filter(t => historico.some(h => h.materia === m.nome && h.topico === t && h.status === 'Concluído')).length;
    div.innerHTML = `
      <div class="materia-header" onclick="toggleMateria(this)">
        <div>${m.nome} <span class="peso">(Peso: ${m.peso})</span> <small style="opacity:0.8;">${concluidos}/${m.topicos.length}</small></div>
        <span class="arrow">Down Arrow</span>
      </div>
      <div class="materia-content">
        ${m.topicos.map(t => {
          const reg = historico.find(h => h.materia === m.nome && h.topico === t);
          const status = reg?.status || 'Pendente';
          const statusClass = status === 'Concluído' ? 'concluido' : status === 'Em andamento' ? 'andamento' : 'pendente';
          return `
            <div class="topico-item">
              <div class="status ${statusClass}"></div>
              <div class="topico-text">${t}</div>
              <div class="topico-actions">
                ${!reg?.inicio ? `<button class="btn-success btn-small" onclick="iniciar('${m.nome}','${t.replace(/'/g, "\\'")}')">Iniciar</button>` : ''}
                ${reg?.inicio && !reg?.fim ? `<button class="btn-warning btn-small" onclick="finalizar('${m.nome}','${t.replace(/'/g, "\\'")}')">Finalizar</button>` : ''}
                <button class="btn-secondary btn-small" onclick="abrirNota('${m.nome}','${t.replace(/'/g, "\\'")}','${(reg?.nota||'').replace(/'/g, "\\'")}')">Note</button>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
    container.appendChild(div);
  });
}

function toggleMateria(header) {
  const content = header.nextElementSibling;
  const arrow = header.querySelector('.arrow');
  content.classList.toggle('open');
  arrow.textContent = content.classList.contains('open') ? 'Up Arrow' : 'Down Arrow';
}

function iniciar(materia, topico) {
  if (historico.some(h => h.materia === materia && h.topico === topico && !h.fim)) return alert('Já em andamento!');
  historico.push({ materia, topico, inicio: new Date().toISOString(), fim: null, status: 'Em andamento', nota: '' });
  salvar();
}

function finalizar(materia, topico) {
  const reg = historico.find(h => h.materia === materia && h.topico === topico && !h.fim);
  if (!reg) return alert('Não iniciado!');
  reg.fim = new Date().toISOString();
  reg.status = 'Concluído';
  salvar();
}

function resetarProgresso() {
  if (confirm('Resetar todo o progresso? (Histórico mantido)')) {
    historico.forEach(h => { h.inicio = null; h.fim = null; h.status = 'Pendente'; h.nota = ''; });
    salvar();
  }
}

let notaAtual = {};
function abrirNota(materia, topico, nota) {
  notaAtual = { materia, topico };
  document.getElementById('notaText').value = nota;
  document.getElementById('notaModal').style.display = 'flex';
}

function salvarNota() {
  const nota = document.getElementById('notaText').value;
  const reg = historico.find(h => h.materia === notaAtual.materia && h.topico === notaAtual.topico);
  if (reg) reg.nota = nota;
  salvar();
  fecharModal();
}

function fecharModal() {
  document.getElementById('notaModal').style.display = 'none';
}

// === CICLO ===
function gerarCiclo() {
  const tempoTotal = parseInt(document.getElementById('cicloTempo').value) || 60;
  const agora = new Date();
  const seteDiasAtras = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);

  cicloAtual = [];

  historico.forEach(h => {
    if (h.inicio) {
      const materia = materias.find(m => m.nome === h.materia);
      if (!materia) return;
      const item = { materia: h.materia, topico: h.topico, peso: materia.peso };
      if (!h.fim) cicloAtual.push({ ...item, tipo: 'Estudo', urgencia: 3 });
      else if (new Date(h.fim) <= seteDiasAtras) cicloAtual.push({ ...item, tipo: 'Revisão', urgencia: 2 });
    }
  });

  if (cicloAtual.length === 0) return alert('Nenhum tópico iniciado!');

  cicloAtual.sort((a, b) => b.urgencia - a.urgencia || b.peso - a.peso);
  const total = cicloAtual.reduce((s, i) => s + i.peso * i.urgencia, 0);
  cicloAtual.forEach(item => {
    const prop = (item.peso * item.urgencia) / total;
    item.minutos = Math.max(3, Math.round(prop * tempoTotal));
  });

  iniciarCiclo();
}

function iniciarCiclo() {
  indiceAtual = 0;
  document.getElementById('cicloAtivo').style.display = 'block';
  document.getElementById('btnProximo').style.display = 'none';
  atualizarCicloUI();
  iniciarTimerTopico();
}

function iniciarTimerTopico() {
  if (indiceAtual >= cicloAtual.length) return finalizarCiclo();
  const item = cicloAtual[indiceAtual];
  tempoRestante = item.minutos * 60;

  timerCiclo = setInterval(() => {
    if (!cicloPausado && tempoRestante > 0) {
      tempoRestante--;
      atualizarTimerDisplay();
      atualizarProgressoCiclo();
    } else if (tempoRestante <= 0) {
      clearInterval(timerCiclo);
      notificarFimTopico();
    }
  }, 1000);
}

function notificarFimTopico() {
  alert(`Tempo esgotado!\n\nTópico: ${cicloAtual[indiceAtual].topico}\n\nClique em "Próximo".`);
  document.getElementById('btnProximo').style.display = 'inline-block';
}

function proximoTopico() {
  indiceAtual++;
  document.getElementById('btnProximo').style.display = 'none';
  if (indiceAtual < cicloAtual.length) {
    atualizarCicloUI();
    iniciarTimerTopico();
  } else {
    finalizarCiclo();
  }
}

function pausarCiclo() {
  cicloPausado = !cicloPausado;
  document.querySelector('#cicloAtivo .btn-warning').textContent = cicloPausado ? 'Retomar' : 'Pausar';
}

function pararCiclo() {
  clearInterval(timerCiclo);
  document.getElementById('cicloAtivo').style.display = 'none';
  cicloAtual = [];
}

function finalizarCiclo() {
  clearInterval(timerCiclo);
  alert('Ciclo concluído!');
  document.getElementById('cicloAtivo').style.display = 'none';
  cicloAtual = [];
}

function atualizarCicloUI() {
  const item = cicloAtual[indiceAtual];
  document.getElementById('cicloTitulo').textContent = `${item.tipo}: ${item.materia}`;
  document.getElementById('topicoAtual').textContent = `${item.topico} (${item.minutos} min)`;
  document.getElementById('progressoTexto').textContent = `${Math.round((indiceAtual / cicloAtual.length) * 100)}%`;
  document.getElementById('progressFill').style.width = `${(indiceAtual / cicloAtual.length) * 100}%`;
}

function atualizarTimerDisplay() {
  const mins = String(Math.floor(tempoRestante / 60)).padStart(2, '0');
  const secs = String(tempoRestante % 60).padStart(2, '0');
  document.getElementById('timerCiclo').textContent = `${mins}:${secs}`;
}

function atualizarProgressoCiclo() {
  const item = cicloAtual[indiceAtual];
  const progTopico = ((item.minutos * 60 - tempoRestante) / (item.minutos * 60)) * 100;
  const total = ((indiceAtual * 100 + progTopico) / cicloAtual.length);
  document.getElementById('progressFill').style.width = `${total}%`;
  document.getElementById('progressoTexto').textContent = `${Math.round(total)}%`;
}

// === POMODORO ===
function iniciarPomodoro() {
  document.getElementById('pomodoroSection').style.display = 'block';
  pomodoroTime = 25 * 60;
  atualizarTimerPomodoro();
  timerInterval = setInterval(() => {
    if (pomodoroTime > 0) {
      pomodoroTime--;
      atualizarTimerPomodoro();
    } else {
      clearInterval(timerInterval);
      alert('Pomodoro concluído! 5 min de pausa.');
    }
  }, 1000);
}

function pausarPomodoro() { clearInterval(timerInterval); }
function pararPomodoro() {
  clearInterval(timerInterval);
  document.getElementById('pomodoroSection').style.display = 'none';
}

function atualizarTimerPomodoro() {
  const mins = String(Math.floor(pomodoroTime / 60)).padStart(2, '0');
  const secs = String(pomodoroTime % 60).padStart(2, '0');
  document.getElementById('timer').textContent = `${mins}:${secs}`;
}

// === UTILS ===
function formatarHora(iso) {
  return new Date(iso).toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
}

function exportarPDF() { window.print(); }

// === INICIALIZAÇÃO ===
setInterval(() => { if (!googleLoaded) initializeGoogleSignIn(); }, 500);
window.onload = () => { atualizarTudo(); };
</script>