<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BB Agente TI ‚Äî Painel Final</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root{
    --azul:#004aad;--verde:#28a745;--amarelo:#ffc107;--vermelho:#dc3545;--bg:#f8f9fa;
    --card:#fff;--borda:#e6eef8;
  }
  *{box-sizing:border-box}body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);color:#222;padding:18px}
  .container{max-width:1100px;margin:0 auto}
  header{background:linear-gradient(135deg,var(--azul),#003d82);color:#fff;padding:24px;border-radius:12px;text-align:center;margin-bottom:18px}
  header h1{margin:0;font-size:1.6rem} header p{margin:6px 0 0;opacity:.9}
  .drive-status{margin:14px 0;text-align:center;font-weight:600}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);border:1px solid var(--borda);text-align:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  button,select{padding:8px 12px;border-radius:8px;border:0;font-weight:600;cursor:pointer}
  .btn-primary{background:var(--azul);color:#fff} .btn-success{background:var(--verde);color:#fff} .btn-warning{background:var(--amarelo);color:#222}
  .btn-danger{background:var(--vermelho);color:#fff}.btn-secondary{background:#6c757d;color:#fff}
  .materia{background:var(--card);border-radius:10px;margin-bottom:12px;border:1px solid var(--borda);overflow:hidden}
  .materia-header{background:var(--azul);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .materia-content{padding:0;max-height:0;overflow:hidden;transition:all .32s}
  .materia-content.open{padding:12px 14px;max-height:1000px}
  .topico-item{display:flex;align-items:center;padding:10px 0;border-bottom:1px dashed #eef3fb;gap:8px;flex-wrap:wrap}
  .topico-text{flex:1}
  .topico-actions{display:flex;gap:6px}
  .btn-small{padding:6px 8px;font-size:.85rem;border-radius:8px}
  .status{width:12px;height:12px;border-radius:50%;border:2px solid #ccc;margin-right:8px}
  .status.pendente{background:#f8d7da;border-color:var(--vermelho)}
  .status.andamento{background:#fff3cd;border-color:var(--amarelo)}
  .status.concluido{background:#d4edda;border-color:var(--verde)}
  .historico table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.9rem}
  .historico th,.historico td{padding:8px;border:1px solid var(--borda);text-align:center}
  .historico th{background:var(--azul);color:#fff}
  .popup{position:fixed;right:18px;bottom:18px;background:linear-gradient(180deg,#fff,#f1fbff);border:1px solid #cfe9ff;padding:14px;border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.15);display:none;z-index:9999;max-width:320px}
  .popup.show{display:block;animation:pop .36s ease-out}
  @keyframes pop{from{transform:translateY(8px) scale(.98);opacity:0}to{transform:none;opacity:1}}
  .backup-info{font-size:.9rem;color:#1e293b;margin-bottom:12px;text-align:center}
  .small{font-size:.85rem;color:#475569}
  .modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:999}
  .modal .card{width:90%;max-width:540px}
  @media(max-width:760px){.topico-actions{width:100%;justify-content:flex-end}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Plano de Estudos ‚Äî BB (Agente de Tecnologia)</h1>
    <p>Dashboard final ‚Äî backups autom√°ticos, Drive, popup e som</p>
  </header>

  <div id="driveStatus" class="drive-status">Carregando integra√ß√£o com Google Drive...</div>
  <div class="backup-info" id="lastBackupInfo">√öltimo backup: ‚Äî</div>

  <div class="controls">
    <select id="cicloTempo"><option value="15">15</option><option value="30" selected>30</option><option value="60">60</option><option value="90">90</option><option value="180">180</option></select>
    <button class="btn-primary" onclick="gerarCiclo()">Gerar Ciclo</button>
    <button class="btn-success" onclick="iniciarPomodoro()">Pomodoro</button>
    <button class="btn-warning" onclick="exportarParaDriveManual()">Backup (Drive)</button>
    <button class="btn-secondary" onclick="listarBackupsDrive()">Restaurar</button>
    <button class="btn-danger" onclick="resetarProgresso()">Resetar Progresso</button>
    <button class="btn-secondary" onclick="exportarPDF()">Exportar PDF</button>
  </div>

  <div class="stats-grid">
    <div class="card"><h3 class="small">Tempo Hoje</h3><p id="tempoHoje">0 min</p></div>
    <div class="card"><h3 class="small">Tempo Semana</h3><p id="tempoSemana">0 min</p></div>
    <div class="card"><h3 class="small">T√≥picos Conclu√≠dos</h3><p id="topicosConcluidos">0</p></div>
    <div class="card"><h3 class="small">Progresso</h3><p id="progressoGeral">0%</p></div>
  </div>

  <div id="materias"></div>

  <div class="historico card" style="margin-top:12px">
    <h3>Hist√≥rico</h3>
    <table>
      <thead><tr><th>Mat√©ria</th><th>T√≥pico</th><th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o</th><th>Status</th><th>A√ß√£o</th></tr></thead>
      <tbody id="tabelaHistorico"></tbody>
    </table>
  </div>
</div>

<!-- popup + audio -->
<div id="popup" class="popup"><strong id="popupTitle">‚ú¶ Ciclo conclu√≠do</strong><div id="popupText" class="small" style="margin-top:8px">Excelente trabalho ‚Äî fa√ßa uma pausa breve!</div></div>
<audio id="alarmSound" preload="auto">
  <!-- Small motivational chime encoded as base64 (short, pleasant). -->
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA... (substitua pelo seu mp3 base64 se desejar)" type="audio/mp3">
</audio>

<!-- nota modal -->
<div id="notaModal" class="modal"><div class="card"><h3>Notas do t√≥pico</h3><textarea id="notaText" style="width:100%;height:120px"></textarea><div style="text-align:right;margin-top:8px"><button class="btn-secondary" onclick="fecharModal()">Cancelar</button><button class="btn-primary" onclick="salvarNota()">Salvar</button></div></div></div>

<script>
/* --------------------
   CONFIG / DADOS
   -------------------- */
const CLIENT_ID = '374929675068-4datkhc3lt6jseb4tuqs8t9hliig2qdl.apps.googleusercontent.com';
const API_KEY = ''; // opcional
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
const DRIVE_FILE_NAME = 'bb-estudo-backup.json'; // arquivo √∫nico no appDataFolder

const materias = [
  {nome:'L√çNGUA PORTUGUESA',topicos:['Compreens√£o de textos','Ortografia oficial','Classe e emprego de palavras','Emprego do acento indicativo de crase','Sintaxe da ora√ß√£o e do per√≠odo','Emprego dos sinais de pontua√ß√£o','Concord√¢ncia verbal e nominal','Reg√™ncia verbal e nominal','Coloca√ß√£o dos pronomes obl√≠quos √°tonos'],peso:2},
  {nome:'L√çNGUA INGLESA',topicos:['Vocabul√°rio fundamental','Aspectos gramaticais b√°sicos'],peso:1},
  {nome:'MATEM√ÅTICA',topicos:['N√∫meros inteiros, racionais e reais','Sistema legal de medidas','Raz√µes e propor√ß√µes','L√≥gica proposicional','No√ß√µes de conjuntos','Rela√ß√µes e fun√ß√µes','Matrizes','Determinantes','Sistemas lineares','Sequ√™ncias','Progress√µes aritm√©ticas e geom√©tricas'],peso:2},
  {nome:'ATUALIDADES DO MERCADO FINANCEIRO',topicos:['Bancos na Era Digital','Internet banking e Mobile banking','Open banking','Fintechs, startups e big techs','Shadow banking','Blockchain e criptomoedas','PIX e arranjos de pagamento','Transforma√ß√£o digital no sistema financeiro'],peso:1},
  {nome:'PROBABILIDADE E ESTAT√çSTICA',topicos:['Representa√ß√£o tabular e gr√°fica','Medidas de tend√™ncia central e dispers√£o','Vari√°veis aleat√≥rias e distribui√ß√µes','Teorema de Bayes e probabilidade condicional','Distribui√ß√£o binomial e normal','No√ß√µes de amostragem e infer√™ncia estat√≠stica'],peso:1},
  {nome:'CONHECIMENTOS BANC√ÅRIOS',topicos:['Sistema Financeiro Nacional','Mercado financeiro','Pol√≠tica monet√°ria e SELIC','Or√ßamento p√∫blico e d√≠vida p√∫blica','Produtos banc√°rios','Mercado de c√¢mbio','Taxas de juros e curva de juros','Lavagem de dinheiro e LGPD','Seguran√ßa cibern√©tica e responsabilidade socioambiental'],peso:2},
  {nome:'TECNOLOGIA DA INFORMA√á√ÉO',topicos:['Aprendizagem de m√°quina','Banco de dados SQL e NoSQL','Big Data','Desenvolvimento Mobile','Estrutura de dados e algoritmos','Ferramentas e linguagens para dados'],peso:3}
];

let historico = JSON.parse(localStorage.getItem('bb-historico-vfinal')) || [];
let lastDriveFileId = localStorage.getItem('bb-drive-fileid') || null;
let lastBackupMeta = JSON.parse(localStorage.getItem('bb-last-backup-meta')) || null;

let cicloAtual = [], indiceAtual = 0, cronCiclo = null, tempoRestante = 0, cicloPausado = false;
let pomodoroTimer = null;

let gapiInited = false, gisInited = false, tokenClient;

/* --------------------
   UI helpers
   -------------------- */
function atualizarBackupInfo(){
  const el = document.getElementById('lastBackupInfo');
  if (lastBackupMeta){
    el.textContent = `√öltimo backup: ${new Date(lastBackupMeta.timestamp).toLocaleString()} (${lastBackupMeta.source})`;
  } else {
    el.textContent = '√öltimo backup: nenhum';
  }
}
function showPopup(title, text, playSound=true){
  const p = document.getElementById('popup');
  document.getElementById('popupTitle').textContent = title;
  document.getElementById('popupText').textContent = text;
  p.classList.add('show');
  setTimeout(()=>p.classList.remove('show'),6000);
  if (playSound){
    const a = document.getElementById('alarmSound');
    // try play, ignore if blocked
    a.currentTime = 0;
    a.play().catch(()=>{});
  }
}

/* --------------------
   BACKUP: single-file strategy
   -------------------- */
/* Ensure we have OAuth token before using gapi.client */
function requestTokenIfNeeded() {
  return new Promise((resolve,reject)=>{
    try {
      const token = gapi.client.getToken && gapi.client.getToken();
      if (token && token.access_token) return resolve(token);
      // request token via tokenClient
      tokenClient.requestAccessToken({prompt:''});
      // wait for token to appear (poll short)
      let attempts=0;
      const iv=setInterval(()=>{
        const t = gapi.client.getToken && gapi.client.getToken();
        attempts++;
        if (t && t.access_token){ clearInterval(iv); resolve(t); }
        if (attempts>20){ clearInterval(iv); reject(new Error('timeout token')); }
      },250);
    } catch(e){ reject(e); }
  });
}

/* Save or update a single file in appDataFolder. If fileId known, update; otherwise try to find by name, else create. */
async function uploadBackupToDrive(dados){
  // ensure gapi initialized and token present
  await requestTokenIfNeeded().catch(e=>{ throw e; });
  const content = JSON.stringify(dados,null,2);
  const boundary = '-------314159265358979323846';
  const delimiter = "\r\n--" + boundary + "\r\n";
  const close_delim = "\r\n--" + boundary + "--";
  const metadata = { name: DRIVE_FILE_NAME, mimeType: 'application/json', parents: ['appDataFolder'] };
  const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter +
      'Content-Type: application/json\r\n\r\n' + content + close_delim;

  // if we have a fileId, try update first
  if (lastDriveFileId){
    try {
      const resp = await gapi.client.request({
        path: `/upload/drive/v3/files/${lastDriveFileId}?uploadType=multipart`,
        method: 'PATCH',
        headers: {'Content-Type': 'multipart/related; boundary=' + boundary},
        body: multipartRequestBody
      });
      return resp;
    } catch(err){
      console.warn('Falha ao atualizar fileId ‚Äî tentaremos criar novo arquivo:', err);
      // fallthrough to create
    }
  }

  // try find existing file by name
  try {
    const find = await gapi.client.drive.files.list({
      spaces: 'appDataFolder',
      q: `name='${DRIVE_FILE_NAME}' and mimeType='application/json'`,
      fields: 'files(id,name,createdTime)',
      pageSize: 1
    });
    if (find.result.files && find.result.files.length>0){
      lastDriveFileId = find.result.files[0].id;
      localStorage.setItem('bb-drive-fileid', lastDriveFileId);
      const resp = await gapi.client.request({
        path: `/upload/drive/v3/files/${lastDriveFileId}?uploadType=multipart`,
        method: 'PATCH',
        headers: {'Content-Type': 'multipart/related; boundary=' + boundary},
        body: multipartRequestBody
      });
      return resp;
    }
  } catch(e){ console.warn('Busca existing file falhou', e); }

  // create new
  const resp = await gapi.client.request({
    path: '/upload/drive/v3/files?uploadType=multipart',
    method: 'POST',
    headers: {'Content-Type': 'multipart/related; boundary=' + boundary},
    body: multipartRequestBody
  });
  // store file id
  try { lastDriveFileId = resp.result.id; localStorage.setItem('bb-drive-fileid', lastDriveFileId); } catch(e){}
  return resp;
}

/* Automatic backup helper ‚Äî tries Drive, falls back to localStorage */
async function realizarBackupAutomatico(notify=false){
  const payload = { version:'vfinal', timestamp: new Date().toISOString(), historico };
  // always store local fallback
  localStorage.setItem('bb-last-local-backup', JSON.stringify(payload));
  // try Drive if gapi initialized
  if (gapiInited && gisInited){
    try {
      await uploadBackupToDrive(payload);
      lastBackupMeta = { timestamp: payload.timestamp, source:'Drive' };
      localStorage.setItem('bb-last-backup-meta', JSON.stringify(lastBackupMeta));
      atualizarBackupInfo();
      if (notify) showPopup('Backup salvo', `Backup salvo no Google Drive (${new Date().toLocaleString()})`, false);
      return true;
    } catch(e){
      console.warn('Backup Drive falhou, salvo localmente', e);
      lastBackupMeta = { timestamp: payload.timestamp, source:'Local' };
      localStorage.setItem('bb-last-backup-meta', JSON.stringify(lastBackupMeta));
      atualizarBackupInfo();
      if (notify) showPopup('Backup local', `Backup salvo localmente (${new Date().toLocaleString()})`, false);
      return false;
    }
  } else {
    lastBackupMeta = { timestamp: payload.timestamp, source:'Local' };
    localStorage.setItem('bb-last-backup-meta', JSON.stringify(lastBackupMeta));
    atualizarBackupInfo();
    if (notify) showPopup('Backup local', `Backup salvo localmente (${new Date().toLocaleString()})`, false);
    return false;
  }
}

/* Try to restore latest backup from Drive (if authorized); otherwise restore local fallback */
async function restaurarUltimoBackupAoCarregar(){
  // prefer Drive if possible
  if (gapiInited && gisInited){
    try {
      await requestTokenIfNeeded();
      // find newest file by name
      const res = await gapi.client.drive.files.list({
        spaces: 'appDataFolder', q:`name='${DRIVE_FILE_NAME}' and mimeType='application/json'`,
        orderBy:'createdTime desc', pageSize:1, fields:'files(id,name,createdTime)'
      });
      const files = res.result.files || [];
      if (files.length){
        const file = files[0];
        const f = await gapi.client.drive.files.get({ fileId: file.id, alt:'media' });
        const dados = typeof f.body==='string' ? JSON.parse(f.body) : f.result;
        if (dados && dados.historico){
          historico = dados.historico;
          lastDriveFileId = file.id;
          localStorage.setItem('bb-drive-fileid', lastDriveFileId);
          lastBackupMeta = { timestamp: dados.timestamp || new Date().toISOString(), source:'Drive' };
          localStorage.setItem('bb-last-backup-meta', JSON.stringify(lastBackupMeta));
          salvarLocalState(false);
          console.log('Backup restaurado do Drive automaticamente.');
          return true;
        }
      }
    } catch(e){ console.warn('Restaura√ß√£o Drive falhou:', e); }
  }
  const local = localStorage.getItem('bb-last-local-backup');
  if (local){
    try {
      const dados = JSON.parse(local);
      if (dados && dados.historico){ historico = dados.historico; lastBackupMeta = { timestamp: dados.timestamp, source:'Local' }; localStorage.setItem('bb-last-backup-meta', JSON.stringify(lastBackupMeta)); salvarLocalState(false); console.log('Backup local restaurado.'); return true; }
    } catch(e){ console.warn('Erro restaurando local fallback', e); }
  }
  return false;
}

/* --------------------
   Persist / UI / Historico
   -------------------- */
function salvarLocalState(alertBackup=true){
  // persist main history and last local backup
  localStorage.setItem('bb-historico-vfinal', JSON.stringify(historico));
  localStorage.setItem('bb-last-local-backup', JSON.stringify({version:'vfinal', timestamp:new Date().toISOString(), historico}));
  atualizarTudo();
  if (alertBackup) realizarBackupAutomatico(false).catch(()=>{});
}

function atualizarTudo(){
  renderizarMaterias();
  atualizarTabela();
  atualizarEstatisticas();
  atualizarBackupInfo();
  atualizarDriveStatusUI();
}

/* UI render */
function renderizarMaterias(){
  const container = document.getElementById('materias');
  container.innerHTML = '';
  materias.forEach(m=>{
    const div=document.createElement('div'); div.className='materia';
    const concluidos = m.topicos.filter(t=> historico.some(h=>h.materia===m.nome && h.topico===t && h.status==='Conclu√≠do')).length;
    div.innerHTML = `
      <div class="materia-header" onclick="toggleMateria(this)"><div>${m.nome} <small style="opacity:.85">(${concluidos}/${m.topicos.length})</small></div><div class="small">Peso ${m.peso} ‚ñæ</div></div>
      <div class="materia-content">
        ${m.topicos.map(t=>{
          const reg = historico.find(h=>h.materia===m.nome && h.topico===t && h.status!=='Removido');
          const status = reg?.status || 'Pendente';
          const cls = status==='Conclu√≠do'?'concluido': status==='Em andamento'?'andamento':'';
          return `<div class="topico-item">
            <div class="status ${status==='Conclu√≠do'?'concluido':status==='Em andamento'?'andamento':'pendente'}"></div>
            <div class="topico-text">${t}</div>
            <div class="topico-actions">
              ${!reg?.inicio ? `<button class="btn-success btn-small" onclick="iniciarTopico('${m.nome}','${escapeJs(t)}')">Iniciar</button>` : ''}
              ${reg?.inicio && !reg?.fim ? `<button class="btn-warning btn-small" onclick="finalizarTopico('${m.nome}','${escapeJs(t)}')">Finalizar</button>` : ''}
              <button class="btn-secondary btn-small" onclick="abrirNota('${m.nome}','${escapeJs(t)}')">Notas</button>
            </div>
          </div>`;
        }).join('')}
      </div>
    `;
    container.appendChild(div);
  });
}
function toggleMateria(header){ header.nextElementSibling.classList.toggle('open'); }

/* Historico table */
function atualizarTabela(){
  const tbody=document.getElementById('tabelaHistorico'); tbody.innerHTML='';
  historico.forEach((h,i)=>{
    const dur = h.fim ? `${Math.round((new Date(h.fim)-new Date(h.inicio))/60000)} min` : '-';
    const tr=document.createElement('tr');
    tr.className = h.status==='Conclu√≠do'?'concluido':h.status==='Em andamento'?'andamento':'';
    tr.innerHTML = `<td>${h.materia}</td><td>${h.topico}</td><td>${h.inicio?formatDate(h.inicio):'-'}</td><td>${h.fim?formatDate(h.fim):'-'}</td><td>${dur}</td><td>${h.status}</td><td><button class="btn-danger btn-small" onclick="excluirRegistro(${i})">Excluir</button></td>`;
    tbody.appendChild(tr);
  });
}
function excluirRegistro(i){ if(confirm('Excluir registro?')){ historico.splice(i,1); salvarLocalState(true); } }

/* Estat√≠sticas */
function atualizarEstatisticas(){
  const hoje = new Date().toISOString().slice(0,10);
  let tempoHoje=0, tempoSemana=0, concluidos=0, totalPesoConcluido=0, totalPeso=0;
  const inicioSemana=new Date(); inicioSemana.setDate(inicioSemana.getDate()-inicioSemana.getDay()+1); inicioSemana.setHours(0,0,0,0);
  materias.forEach(m=> totalPeso += m.peso * m.topicos.length);
  historico.forEach(h=>{
    if (h.fim){
      const inicio = new Date(h.inicio), fim=new Date(h.fim);
      const mins = Math.round((fim-inicio)/60000);
      if (h.inicio.slice(0,10)===hoje) tempoHoje+=mins;
      if (inicio>=inicioSemana) tempoSemana+=mins;
      if (h.status==='Conclu√≠do'){ concluidos++; const materia = materias.find(x=>x.nome===h.materia); if (materia) totalPesoConcluido += materia.peso; }
    }
  });
  document.getElementById('tempoHoje').textContent = tempoHoje + ' min';
  document.getElementById('tempoSemana').textContent = tempoSemana + ' min';
  document.getElementById('topicosConcluidos').textContent = concluidos;
  document.getElementById('progressoGeral').textContent = totalPeso>0 ? Math.round((totalPesoConcluido/totalPeso)*100) + '%' : '0%';
}

/* --------------------
   Iniciar / Finalizar topico (com backup autom√°tico)
   -------------------- */
function iniciarTopico(materia, topico){
  // prevent duplicates
  if (historico.some(h=>h.materia===materia && h.topico===topico && !h.fim)) return alert('T√≥pico j√° em andamento!');
  historico.push({ materia, topico, inicio: new Date().toISOString(), fim:null, status:'Em andamento', nota:'' });
  salvarLocalState(false);
  // automatic backup (try Drive)
  realizarBackupAutomatico(false).catch(()=>{});
  atualizarTudo();
}
function finalizarTopico(materia, topico){
  const reg = historico.find(h=>h.materia===materia && h.topico===topico && !h.fim);
  if(!reg) return alert('T√≥pico n√£o iniciado.');
  reg.fim = new Date().toISOString();
  reg.status = 'Conclu√≠do';
  salvarLocalState(false);
  // backup and notify
  realizarBackupAutomatico(false).then(()=>{ /* ok */ }).catch(()=>{});
  atualizarTudo();
}

/* Notas modal */
let notaContext = null;
function abrirNota(materia, topico){
  notaContext = { materia, topico };
  const reg = historico.find(h=>h.materia===materia && h.topico===topico);
  document.getElementById('notaText').value = reg?.nota || '';
  document.getElementById('notaModal').style.display = 'flex';
}
function fecharModal(){ document.getElementById('notaModal').style.display = 'none'; notaContext=null; }
function salvarNota(){ if(!notaContext) return; const reg = historico.find(h=>h.materia===notaContext.materia && h.topico===notaContext.topico); if(reg) reg.nota = document.getElementById('notaText').value; salvarLocalState(false); fecharModal(); }

/* --------------------
   CICLO inteligente (prioriza pendentes por peso)
   -------------------- */
function gerarCiclo(){
  const totalMin = parseInt(document.getElementById('cicloTempo').value)||30;
  // build list of pending topics
  const pendentes = [];
  materias.forEach(m=>{
    m.topicos.forEach(t=>{
      const concluido = historico.some(h=>h.materia===m.nome && h.topico===t && h.status==='Conclu√≠do');
      if(!concluido) pendentes.push({materia:m.nome, topico:t, peso:m.peso});
    });
  });
  if(!pendentes.length) return alert('Nenhum t√≥pico pendente. √ìtimo trabalho!');
  const pesoTotal = pendentes.reduce((s,i)=>s+i.peso,0);
  cicloAtual = pendentes.map(p => ({...p, minutos: Math.max(3, Math.round((p.peso/pesoTotal)*totalMin))}));
  indiceAtual = 0;
  iniciarCiclo();
}

function iniciarCiclo(){
  if(!cicloAtual.length) return;
  document.getElementById('cicloAtivo')?.remove?.();
  // create simple on-screen area (reusing popup for notification and show)
  // start timer for first topic
  iniciarTopicoAutomaticoParaCiclo();
}
function iniciarTopicoAutomaticoParaCiclo(){
  if(indiceAtual>=cicloAtual.length){ finalizarCicloComSucesso(); return; }
  const item = cicloAtual[indiceAtual];
  // start (create history record if not already)
  if(!historico.some(h=>h.materia===item.materia && h.topico===item.topico && !h.fim)){
    historico.push({materia:item.materia, topico:item.topico, inicio:new Date().toISOString(), fim:null, status:'Em andamento', nota:''});
    salvarLocalState(false);
    realizarBackupAutomatico(false).catch(()=>{});
  }
  tempoRestante = item.minutos * 60;
  if(cronCiclo) clearInterval(cronCiclo);
  cronCiclo = setInterval(()=>{
    if(!cicloPausado){
      tempoRestante--;
      if(tempoRestante<=0){
        clearInterval(cronCiclo);
        // finalize this topic
        const reg = historico.find(h=>h.materia===item.materia && h.topico===item.topico && !h.fim);
        if(reg){ reg.fim = new Date().toISOString(); reg.status='Conclu√≠do'; salvarLocalState(false); realizarBackupAutomatico(false).catch(()=>{}); }
        // notify with popup + sound
        showPopup('‚ú® Ciclo conclu√≠do', `Voc√™ finalizou: ${item.topico}. Excelente trabalho!`, true);
        // move to next
        indiceAtual++;
        // small delay before next to allow user to breathe
        setTimeout(()=>{ iniciarTopicoAutomaticoParaCiclo(); }, 1200);
      }
    }
  },1000);
}

/* finalize */
function finalizarCicloComSucesso(){
  if(cronCiclo) clearInterval(cronCiclo);
  showPopup('‚úÖ Ciclo completo', `Todos os itens do ciclo foram conclu√≠dos!`, true);
  indiceAtual = 0; cicloAtual = [];
  atualizarTudo();
}

/* --------------------
   POMODORO
   -------------------- */
function iniciarPomodoro(){
  if(pomodoroTimer) clearInterval(pomodoroTimer);
  let time = 25*60;
  pomodoroTimer = setInterval(()=>{ time--; const mins = String(Math.floor(time/60)).padStart(2,'0'); const secs = String(time%60).padStart(2,'0'); document.title = `‚è± ${mins}:${secs} ‚Äî BB`; if(time<=0){ clearInterval(pomodoroTimer); showPopup('üîî Pomodoro conclu√≠do','Parab√©ns ‚Äî fa√ßa 5 min de pausa', true); document.title = 'BB ‚Äî Plano de Estudos'; } },1000);
}

/* --------------------
   Drive UI / Auth init
   -------------------- */
function atualizarDriveStatusUI(){
  const el = document.getElementById('driveStatus');
  if(!gapiInited || !gisInited){ el.textContent = 'Drive: carregando integra√ß√£o...'; return; }
  const token = gapi.client.getToken && gapi.client.getToken();
  if(token && token.access_token){
    el.innerHTML = `Conectado ao Google Drive ‚Äî arquivo: ${lastDriveFileId?lastDriveFileId:'(n√£o definido)'} <button class="btn-warning btn-small" onclick="exportarParaDriveManual()">Backup agora</button> <button class="btn-secondary btn-small" onclick="listarBackupsDrive()">Restaurar</button>`;
  } else {
    el.innerHTML = `Drive: n√£o autenticado ‚Äî permita acesso para backups (clique no bot√£o de login Google, canto superior do navegador).`;
  }
}

/* manual export (button) */
async function exportarParaDriveManual(){
  const payload = { version:'vfinal', timestamp:new Date().toISOString(), historico };
  try{
    await requestTokenIfNeeded();
    await uploadBackupToDrive(payload);
    lastBackupMeta = { timestamp: payload.timestamp, source:'Drive' };
    localStorage.setItem('bb-last-backup-meta', JSON.stringify(lastBackupMeta));
    atualizarBackupInfo();
    showPopup('Backup Drive salvo', `Backup salvo no Drive (${new Date().toLocaleString()})`, false);
  }catch(e){
    console.warn('export manual failed', e);
    localStorage.setItem('bb-last-local-backup', JSON.stringify(payload));
    lastBackupMeta = { timestamp: payload.timestamp, source:'Local' };
    localStorage.setItem('bb-last-backup-meta', JSON.stringify(lastBackupMeta));
    atualizarBackupInfo();
    showPopup('Backup local salvo', 'Houve falha no Drive ‚Äî backup local salvo', false);
  }
}

/* list & restore (manual) */
async function listarBackupsDrive(){
  try{
    await requestTokenIfNeeded();
    const res = await gapi.client.drive.files.list({spaces:'appDataFolder', q:`name='${DRIVE_FILE_NAME}'`, orderBy:'createdTime desc', pageSize:10, fields:'files(id,name,createdTime)'});
    const files = res.result.files || [];
    if(!files.length){ alert('Nenhum backup encontrado no Drive.'); return; }
    const list = files.map(f => `${f.name} (id:${f.id})`).join('\n');
    const id = prompt('Backups:\n\n' + list + '\n\nCole o ID para restaurar:');
    if(!id) return;
    const file = await gapi.client.drive.files.get({ fileId: id, alt:'media' });
    const dados = typeof file.body==='string' ? JSON.parse(file.body) : file.result;
    if(dados && dados.historico && confirm('Restaurar backup selecionado?')){ historico = dados.historico; lastDriveFileId = id; localStorage.setItem('bb-drive-fileid', id); localStorage.setItem('bb-last-backup-meta', JSON.stringify({timestamp:dados.timestamp||new Date().toISOString(), source:'Drive'})); salvarLocalState(false); showPopup('Restaurado','Backup restaurado com sucesso (Drive)',false); }
  }catch(e){ console.error(e); alert('Erro ao acessar backups do Drive.'); }
}

/* --------------------
   util
   -------------------- */
function formatDate(iso){ if(!iso) return '-'; return new Date(iso).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}); }
function escapeJs(s){ return s.replace(/'/g,"\\'"); }
function resetarProgresso(){ if(confirm('Resetar progresso (mant√©m hist√≥rico)?')){ historico.forEach(h=>{ h.inicio=null; h.fim=null; h.status='Pendente'; h.nota=''; }); salvarLocalState(true); } }
function exportarPDF(){ window.print(); }

/* --------------------
   GOOGLE init (gapi + gis)
   -------------------- */
function initializeGapi(){
  gapi.load('client', async ()=>{
    try{ await gapi.client.init({ apiKey: API_KEY || undefined, discoveryDocs: [DISCOVERY_DOC] }); }catch(e){ console.warn('GAPI init',e); }
    gapiInited = true; atualizarDriveStatusUI();
    // attempt restore if token present (manual login may be required)
    try{ await restaurarUltimoBackupAoCarregar(); }catch(e){ console.warn('restore on load', e); }
    atualizarTudo();
  });
}
function initializeGis(){
  tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: (resp)=>{ if(resp.error) console.error(resp); else { console.log('token ok'); atualizarDriveStatusUI(); restaurarUltimoBackupAoCarregar().catch(()=>{}); } } });
  gisInited = true;
  atualizarDriveStatusUI();
}

/* When GSI provides credential response (if using auto sign-in) */
function handleCredentialResponse(response){ try{ tokenClient.requestAccessToken({ prompt:'' }); }catch(e){ console.warn(e); } }

/* --------------------
   initialization
   -------------------- */
window.addEventListener('load', async ()=>{
  initializeGis();
  initializeGapi();
  // restore local fallback quickly to render UI while Drive async loads
  const local = localStorage.getItem('bb-last-local-backup');
  if(local){
    try{ const dados=JSON.parse(local); if(dados && dados.historico){ historico = dados.historico; lastBackupMeta = { timestamp:dados.timestamp, source:'Local'}; localStorage.setItem('bb-last-backup-meta', JSON.stringify(lastBackupMeta)); } }catch(e){console.warn(e);}
  }
  lastDriveFileId = localStorage.getItem('bb-drive-fileid') || lastDriveFileId;
  atualizarBackupInfo();
  atualizarTudo();
});

/* expose for Google button callback */
window.handleCredentialResponse = handleCredentialResponse;

</script>
</body>
</html>
